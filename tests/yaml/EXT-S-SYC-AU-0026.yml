resources:
  - name: EXT_S_SYC_AU_0026_fileSpec
    type: FileSpec
    configuration:
      sourceArtifactory: s_artifactory
      pattern: "test-automation-generic-local/EXT_S_LX_AU_0026.txt"
pipelines:
  - name: EXT_S_SYC_AU_0026
    steps:
      - name: EXT_S_SYC_AU_0026_1
        type: Bash
        configuration:
          integrations:
            - name: s_artifactory
          outputResources:
            - name: EXT_S_SYC_AU_0026_fileSpec
        execution:
          onExecute:
            - echo "${run_id}" > EXT_S_LX_AU_0026.txt
            - jfrog rt upload EXT_S_LX_AU_0026.txt test-automation-generic-local
            - xrayUrl="${res_EXT_S_SYC_AU_0026_fileSpec_sourceArtifactory_url/%artifactory/xray}"
            - curlOptions="--silent --retry 3 -w %{http_code} -u $res_EXT_S_SYC_AU_0026_fileSpec_sourceArtifactory_user:$res_EXT_S_SYC_AU_0026_fileSpec_sourceArtifactory_apikey"
            - if [ "$no_verify_ssl" == "true" ]; then curlOptions+=" --insecure"; fi
            - "echo '{\"name\": \"EXT_S_SYC_AU_0026\",\"description\": \"License policy\",\"type\": \"license\",\"rules\": [{\"name\": \"lic_rule\",\"criteria\": {\"allowed_licenses\": [\"MIT\"],\"allow_unknown\": false},\"actions\": {\"fail_build\": true},\"priority\": 1}]}' > $step_tmp_dir/policy_payload"
            - "status=$(curl $curlOptions -H 'Content-Type: application/json' -XPOST \"$xrayUrl/api/v2/policies\" --output $step_tmp_dir/response -T \"$step_tmp_dir/policy_payload\")"
            - cat $step_tmp_dir/response
            - if [ $status -gt 299 ]; then return 1; fi
            - "echo '{\"general_data\": {\"name\": \"EXT_S_SYC_AU_0026\",\"description\": \"EXT_S_SYC_AU_0026 watch\",\"active\": true},\"project_resources\": {\"resources\": [{\"type\": \"repository\",\"bin_mgr_id\": \"default\",\"name\": \"test-automation-generic-local\",\"filters\": [{\"type\": \"regex\",\"value\": \"EXT_S_LX_AU_0026.*\"}]}]},\"assigned_policies\": [{\"name\": \"EXT_S_SYC_AU_0026\",\"type\": \"license\"}]}}' > $step_tmp_dir/watch_payload"
            - "status=$(curl $curlOptions -H 'Content-Type: application/json' -XPOST \"$xrayUrl/api/v2/watches\" --output $step_tmp_dir/response -T \"$step_tmp_dir/watch_payload\")"
            - cat $step_tmp_dir/response
            - if [ $status -gt 299 ]; then return 1; fi

      - name: EXT_S_SYC_AU_0026_2
        type: UploadArtifact
        configuration:
          targetPath: "test-automation-generic-local/EXT_S_SYC_AU_0026"
          autoPublishBuildInfo: true
          xrayScan: true
          integrations:
            - name: s_artifactory
          inputResources:
            - name: EXT_S_SYC_AU_0026_fileSpec
